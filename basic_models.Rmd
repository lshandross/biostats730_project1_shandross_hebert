---
title: "R Notebook"
output: html_notebook
---

```{r}
library(tidyverse)
library(brms)
library(arm)
```

```{r}
# Reading in data
set.seed(1234)
setwd("C:/UMass/730/Project")
heart <- read.csv("heart_failure_clinical_records_dataset.csv")
heartt <- heart[sample(nrow(heart), 100), ]
heartt
```

```{r}
dir.create("output")
```

```{r}
# Full model with test data
fullmodtest <- brm(formula = DEATH_EVENT ~ ., 
                data = heartt,
                family = bernoulli(link = "logit"),
                chains = 4, 
                iter = 5000,
                warmup = 500,
                control = list(max_treedepth = 20),
                cores = getOption("mc.cores", 4), 
                file = "output/fullmodtest")
```

```{r}
summary(fullmodtest)
```

```{r}
fullmodtest2 <- brm(formula = DEATH_EVENT ~ ., 
                data = heartt,
                family = bernoulli(link = "logit"),
                chains = 4, 
                iter = 2000,
                warmup = 500,
                control = list(max_treedepth = 15),
                cores = getOption("mc.cores", 4), 
                file = "output/fullmodtest2")
```

```{r}
summary(fullmodtest2)
```
```{r}
# Intercept-only model with test data
intmodtest <- brm(formula = DEATH_EVENT ~ 1, 
                data = heartt,
                family = bernoulli(link = "logit"),
                chains = 4, 
                iter = 2000,
                warmup = 500,
                control = list(max_treedepth = 15),
                cores = getOption("mc.cores", 4), 
                file = "output/intmodtest")
```

```{r}
summary(intmodtest)
```

```{r}
# Reduced model with test data
redmodtest <- brm(formula = DEATH_EVENT ~ ejection_fraction + serum_creatinine, 
                data = heartt,
                family = bernoulli(link = "logit"),
                chains = 4, 
                iter = 2000,
                warmup = 500,
                control = list(max_treedepth = 15),
                cores = getOption("mc.cores", 4), 
                file = "output/redmodtest")
```

```{r}
summary(redmodtest)
```

```{r}
# Full model test with 1,000 iterations
fullmodtest3 <- brm(formula = DEATH_EVENT ~ ., 
                data = heartt,
                family = bernoulli(link = "logit"),
                chains = 4, 
                iter = 1000,
                warmup = 500,
                control = list(max_treedepth = 15),
                cores = getOption("mc.cores", 4), 
                file = "output/fullmodtest3")
```

```{r}
summary(fullmodtest3)
```

```{r}
# Intercept-only model test with 1,000 iterations
intmodtest2 <- brm(formula = DEATH_EVENT ~ 1, 
                data = heartt,
                family = bernoulli(link = "logit"),
                chains = 4, 
                iter = 1000,
                warmup = 500,
                control = list(max_treedepth = 15),
                cores = getOption("mc.cores", 4), 
                file = "output/intmodtest2")
```

```{r}
summary(intmodtest2)
```

```{r}
# Reduced model test with 1,000 iterations
redmodtest2 <- brm(formula = DEATH_EVENT ~ ejection_fraction + serum_creatinine, 
                data = heartt,
                family = bernoulli(link = "logit"),
                chains = 4, 
                iter = 1000,
                warmup = 500,
                control = list(max_treedepth = 15),
                cores = getOption("mc.cores", 4), 
                file = "output/redmodtest2")
```

```{r}
summary(redmodtest2)
```

```{r}
# Full model
fullmod <- brm(formula = DEATH_EVENT ~ ., 
                data = heart,
                family = bernoulli(link = "logit"),
                chains = 4, 
                iter = 1000,
                warmup = 500,
               control = list(max_treedepth = 20),
                cores = getOption("mc.cores", 4), 
                file = "output/fullmod3")
```

```{r}
summary(fullmod)
```

```{r}
# Intercept-only model
intmod <- brm(formula = DEATH_EVENT ~ 1, 
                data = heart,
                family = bernoulli(link = "logit"),
                chains = 4, 
                iter = 1000,
                warmup = 500,
               control = list(max_treedepth = 20),
                cores = getOption("mc.cores", 4), 
                file = "output/intmod")
```

```{r}
summary(intmod)
```

```{r}
# Reduced model
redmod <- brm(formula = DEATH_EVENT ~ ejection_fraction + serum_creatinine, 
                data = heart,
                family = bernoulli(link = "logit"),
                chains = 4, 
                iter = 1000,
                warmup = 500,
               control = list(max_treedepth = 20),
                cores = getOption("mc.cores", 4), 
                file = "output/redmod")
```

```{r}
summary(redmod)
```

```{r}
# Posterior prediction for full model, intercept-only model, 
# and reduced model
ynewfull <- posterior_predict(fullmod)
ynewint <- posterior_predict(intmod)
ynewred <- posterior_predict(redmod)
```

```{r}
# Point estimates for all models
ytildefull <- apply(ynewfull, 2, mean)
ytildeint <- apply(ynewint, 2, mean)
ytildered <- apply(ynewred, 2, mean)
```

```{r}
# Residuals for all models
resfull <- heart$DEATH_EVENT - ytildefull
resint <- heart$DEATH_EVENT - ytildeint
resred <- heart$DEATH_EVENT - ytildered
```

```{r}
# Full model residuals plotted against age, binned
binnedplot(heart$age, resfull,
           xlab = "Age",
           main = "Full model residuals plotted against age")
```

```{r}
# Full model residuals plotted against ejection fraction, binned
binnedplot(heart$ejection_fraction, resfull,
           xlab = "Ejection fraction",
           main = "Full model residuals plotted against ejection fraction")
```

```{r}
# Full model residuals plotted against log serum creatinine, binned
binnedplot(log(heart$serum_creatinine), resfull,
           xlab = "Serum creatinine",
           main = "Full model residuals plotted against log serum creatinine")
```

```{r}
# Intercept-only model plotted against ejection fraction
binnedplot(heart$ejection_fraction, resint,
           xlab = "Ejection fraction",
           main = "Intercept-only model residuals plotted against ejection fraction")
```

```{r}
# Reduced model plotted against ejection fraction
binnedplot(heart$ejection_fraction, resred,
           xlab = "Ejection fraction",
           main = "Reduced model residuals plotted against ejection fraction")
```

```{r}
# Reduced model plotted against log serum creatinine
binnedplot(log(heart$serum_creatinine), resred,
           xlab = "Serum creatinine",
           main = "Reduced model residuals plotted against log serum creatinine")
```

All of the models underpredict death at low ejection fraction levels. So, a posterior predictive check should be done for ejection fraction at or below 25. 

```{r}
# Summary statistic function
summ_stat <- function(y, ejection_fraction)
  sum(y * (ejection_fraction <= quantile(ejection_fraction, 0.15))) / sum((ejection_fraction) <= quantile(ejection_fraction, 0.15))
```

```{r}
# Posterior predictive histogram for full model
tobs <- summ_stat(heart$DEATH_EVENT, heart$ejection_fraction)
tyrepfull <- apply(ynewfull, 1, summ_stat, heart$ejection_fraction)
hist(tyrepfull, main = "Posterior predictive histogram for full model")
abline(v = tobs)
```

```{r}
# Posterior predictive histogram for intercept-only model
tyrepint <- apply(ynewint, 1, summ_stat, heart$ejection_fraction)
hist(tyrepint, xlim = c(0.1, 0.7), main = "Posterior predictive histogram for intercept-only model")
abline(v = tobs)
```

```{r}
# Posterior predictive histogram for reduced model
tyrepred <- apply(ynewred, 1, summ_stat, heart$ejection_fraction)
hist(tyrepred, main = "Posterior predictive histogram for reduced model")
abline(v = tobs)
```

Based on these in-sample model checks, it seems that the full model actually performs a bit better than the reduced model, unlike the reference paper. This is a bit unsurprising, however, as the full model is more informed by the data than the reduced model. 
